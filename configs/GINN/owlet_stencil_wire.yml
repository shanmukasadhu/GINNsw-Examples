###################
## Owlet Acoustic Stencil Design with GINNs
###################
wandb_experiment_name: 'owlet_stencil_acoustic'

# put all reused variables into vars
vars:
  nx: 3 # input is 3D (cylindrical stencil)
  nz: 2 # dimension of the modulation vector (2D latent space for design exploration)
  ginn_bsize: 1 # number of ginn models to train in parallel
  val_plot_grid: [3, 3] # [n_first_dims, shapes_per_dim]; sample 3x3 grid from 2D latent
  problem_str: 'owlet_stencil'
  ginn_on: 1
  n_points_surface: 16384  ## number of points for surface sampling
  nf_is_density: False  # use SDF (signed distance field)
  level_set: 0.0

  # Stencil geometry (in meters)
  stencil_radius: 0.013  # 13mm radius
  stencil_height: 0.005  # 5mm height
  min_hole_diameter: 0.0005  # 0.5mm minimum
  max_hole_diameter: 0.002  # 2mm maximum
  min_wall_thickness: 0.0008  # 0.8mm for 3D printing

# useful global variables
nx: ${vars.nx}
nz: ${vars.nz}
ginn_bsize: ${vars.ginn_bsize}
level_set: ${vars.level_set}
nf_is_density: ${vars.nf_is_density}

###################
## Model
###################
model:
  model_str: 'cond_wire'  # Use WIRE network (wavelet-based)
  nx: ${vars.nx}
  nz: ${vars.nz}
  return_density: ${vars.nf_is_density}
  w0_initial: 18
  wire_scale: 6
  layers: [128, 128, 128]  # 3 hidden layers with 128 neurons

reset_zlatents_every_n_epochs: 1  # resample latents each epoch for diversity
latent_sampling:
  nz: ${vars.nz}
  ginn_bsize: ${vars.ginn_bsize}
  z_sample_method: 'equidistant'  # any of ['uniform', 'normal', 'equidistant']
  val_plot_grid: ${vars.val_plot_grid}
  z_sample_interval: [-0.5, 0.5]  # latent space range

###################
## Acoustic Configuration
###################
acoustic:
  target_frequencies: [500, 1000, 2000, 4000, 8000]  # Hz (audible range for Owlet)
  target_angles: [0, 30, 60, 90, 120, 150, 180]  # degrees
  target_response_type: 'frontal_bias'  # 'frontal_bias' or 'omnidirectional'
  speed_of_sound: 343.0  # m/s in air

###################
## Data
###################
data:
  simjeb_ids: []  # not used for Owlet

###################
## GINN
###################
train_plot_max_n_shapes: 4
plot_every_n_epochs: 50
valid_every_n_epochs: 2000

###################
## Adaptive penalty (for augmented Lagrangian)
###################
use_augmented_lagrangian: True
adaptive_penalty:
  gamma: 0.01
  epsilon: 1.0e-8
  alpha: 0.9

###################
## Loss-balancing
###################
## Objective function (what we're optimizing)
objective: 'angular_div'  # maximize angular diversity

## Field losses (for topology optimization - not used for Owlet)
field_losses: []

## Data losses (not used for pure GINN)
lambda_data: 0.0
lambda_lip: 0.0
lambda_dirichlet: 0.0

### Geometric constraints (local)
lambda_if: ${eval:${vars.ginn_on} * 1}  # interface constraint (base & top)
lambda_env: ${eval:${vars.ginn_on} * 1}  # envelope constraint (outside cylinder)
lambda_obst: 0.0  # no obstacles
lambda_if_normal: ${eval:${vars.ginn_on} * 1.0}  # normal constraint

### Geometric constraints (global)
lambda_eikonal: ${eval:${vars.ginn_on} * 1.0}  # SDF property |âˆ‡f| = 1
lambda_scc: ${eval:${vars.ginn_on} * 50}  # connectedness (single component)
lambda_curv: 0.5  # smoothness (lower than default to allow sharper holes)

### Acoustic losses (NEW)
lambda_freq_response: 0.0  # match target frequency response (set to 0 to use diversity)
lambda_angular_div: 5.0  # MAIN OBJECTIVE: maximize angular diversity
lambda_directional: 2.0  # enhance directional selectivity
lambda_hole_size: 1.0  # constrain hole sizes

# Curvature and diversity settings
max_curv: 0  # no max curvature (allow sharp features for diffraction)
max_div: -0.1  # minimum diversity threshold

start_curv: 500  # start curvature loss after 500 epochs
start_div: 500  # start diversity loss after 500 epochs

scale_curv: 5.0e-4  # scale for curvature loss (smaller = sharper features OK)
scale_div: 1.0
scale_chamfer_div: 1
scale_vol: 1
scale_comp: 1
scale_eikonal: 0.1

dirichlet_use_surface_points: True

###################
## Curvature
###################
curvature_expression: '4*H**2 - 2*K'  # E_strain (surface strain energy)
strain_curvature_clip_max: 1.0e+6
curvature_use_gradnorm_weights: False
curvature_pts_source: 'surface'  # compute curvature on surface points
exclude_surface_points_close_to_interface_cutoff: 0.002  # 2mm (smaller for small stencil)

###################
## Diversity
###################
diversity_pts_source: 'surface'  # compute diversity on surface points
div_norm_order: 2  # Euclidean distance
div_neighbor_agg_fn: 'min'  # minimal aggregation

###################
## SCC algorithm (Connectedness via Persistent Homology)
###################
ph:
  nx: ${vars.nx}
  problem_str: ${vars.problem_str}
  ginn_bsize: ${vars.ginn_bsize}
  is_density: ${vars.nf_is_density}
  iso_level: 0.0
  ph_1_hole_level: 0.06
  ph_loss_maxdim: 1
  ph_loss_target_betti: [1, 0, 0]  # 1 connected component, 0 holes (genus 0)
  scc_penalty_norm_eps: 1.0e-4
  scc_n_grid_points: 32  # reduced grid for memory efficiency
  evaluate_ph_grid_per_shape: True

###################
## Surface points
###################
surface:
  nx: ${vars.nx}
  n_points_surface: ${vars.n_points_surface}
  level_set: ${vars.level_set}
  do_numerical_surface_points: False
  bin_search_steps: 10
  equidistant_init_grid: True
  do_uniform_resampling: True
  recompute_every_n_epochs: 1

###################
## DIVERSITY
###################
# Diversity is handled by angular_div loss

###################
## LOGGING
###################
log_level: 'INFO'

## Multi-processing
num_workers: ${eval:min(${vars.ginn_bsize},8)}

## Plotting
plot:
  val_plot_grid: ${vars.val_plot_grid}
  problem_str: ${vars.problem_str}
  fig_size: [12, 7]
  level_set: ${vars.level_set}
  show_colorbar: True

meshing:
  level_set: ${vars.level_set}
  nf_is_density: ${vars.nf_is_density}
  mc_resolution: 128  # marching cubes resolution
  mesh_reduction: 0.9  # reduce to 10% of original (for faster rendering)

## Specific plots
plot_shape: True
val_plot_shape: True
plot_surface_points: True
plot_ph_diagram: True
plot_surface_pts_every_n_epochs: 100

## Timer
timer:
  print: False
  accumulate: True

###################
## Problem
###################
problem:
  problem_str: ${vars.problem_str}
  stencil_radius: ${vars.stencil_radius}
  stencil_height: ${vars.stencil_height}
  min_hole_diameter: ${vars.min_hole_diameter}
  max_hole_diameter: ${vars.max_hole_diameter}
  min_wall_thickness: ${vars.min_wall_thickness}

problem_sampling:
  nx: ${vars.nx}
  n_points_domain: 2048
  n_points_envelope: 4096
  n_points_interfaces: 4096
  n_points_normals: 4096
  n_points_surface: ${vars.n_points_surface}

###################
## Training
###################
max_epochs: 5000
lr: 0.001
opt: adam  # adam optimizer

use_scheduler: False
scheduler_gamma: 0.5
decay_steps: 5000

grad_clipping:
  grad_clipping_on: True
  grad_clip: 0.5
  auto_clip_on: True

## Weight saving
model_save_path: 'path/to/dir'
save_every_n_epochs: 50
overwrite_existing_saved_model: True
save_optimizer: True

## Weight loading
load_mos: False
load_model: False
load_optimizer: False
load_scheduler: False
